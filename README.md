# Документация Ansible Playbook для установки ClickHouse

## Описание

Этот Ansible playbook выполняет установку и базовую настройку ClickHouse - колоночной СУБД с открытым исходным кодом, оптимизированной для аналитических запросов.

## Переменные

- `clickhouse_version` - версия ClickHouse для установки (должна быть указана при вызове playbook)

## Задачи

### 1. Установка зависимостей
Устанавливает необходимые пакеты для работы с репозиториями:
- `apt-transport-https` - поддержка HTTPS для APT
- `ca-certificates` - сертификаты CA
- `curl` - утилита для загрузки файлов
- `gnupg` - утилиты для работы с GPG

### 2. Создание директории для GPG-ключей
Создает директорию `/usr/share/keyrings` с правами 0755 для хранения GPG-ключей.

### 3. Добавление GPG-ключа ClickHouse
Загружает GPG-ключ для верификации пакетов ClickHouse из официального репозитория и сохраняет его в `/usr/share/keyrings/clickhouse-keyring.gpg`.

### 4. Проверка прав на GPG-ключ
Устанавливает правильные права (0644) на файл GPG-ключа.

### 5. Создание директории для файлов репозиториев
Создает директорию `/etc/apt/sources.list.d` с правами 0755 для хранения дополнительных файлов репозиториев.

### 6. Добавление репозитория ClickHouse
Создает файл `/etc/apt/sources.list.d/clickhouse.list` с настройками репозитория ClickHouse, указывая на использование ранее добавленного GPG-ключа.

### 7. Обновление кеша пакетов
Обновляет кеш пакетов APT после добавления нового репозитория.

### 8. Установка пакетов ClickHouse
Устанавливает указанные пакеты ClickHouse:
- `clickhouse-server` - сервер ClickHouse
- `clickhouse-client` - клиентская утилита
- `clickhouse-common-static` - общие файлы

Параметр `allow_downgrade: true` разрешает понижение версии пакета при необходимости.

### 9. Запуск и включение сервиса ClickHouse
Обеспечивает запуск сервиса `clickhouse-server` и его автоматический запуск при загрузке системы.

### 10. Получение версии ClickHouse
Выполняет запрос к серверу ClickHouse для получения его версии и сохраняет результат в переменную `ch_version`.

### 11. Вывод установленной версии
Отображает установленную версию ClickHouse с помощью модуля `debug`.

### 12. Создание базы данных
Создает базу данных `logs` в ClickHouse. Игнорирует ошибку, если база данных уже существует (код ошибки 82).

## Использование

Пример вызова playbook с указанием версии:
```bash
ansible-playbook install_clickhouse.yml -e "clickhouse_version=22.8.5.29"
```

## Требования

- Ansible 2.9+
- Ubuntu/Debian система (playbook использует модули apt)
- Доступ в интернет для загрузки пакетов
- Права root/sudo для выполнения задач

## Примечания

- Playbook поддерживает только Debian-based системы
- Для других дистрибутивов потребуется адаптация (использование yum вместо apt и т.д.)
- Убедитесь, что указанная версия ClickHouse существует в репозитории